<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obfuscator Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-color: #0f1115;
            --card-bg: #161b22;
            --border-color: #30363d;
            --accent-primary: #3b82f6;
            --accent-hover: #60a5fa;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --code-bg: #0d1117;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .glass-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Switches */
        .form-switch .form-check-input {
            background-color: #334155;
            border-color: #475569;
            cursor: pointer;
        }
        .form-switch .form-check-input:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .form-check-label {
            transition: color 0.2s;
        }

        /* Editor */
        .code-editor {
            background-color: var(--code-bg) !important; 
            color: #e2e8f0 !important;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            resize: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .code-editor:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .code-editor[readonly] {
            background-color: #050505 !important;
            color: #a3e635 !important;
            opacity: 1;
        }

        /* Preset Buttons */
        .preset-btn-group {
            display: flex;
            gap: 0;
        }
        .btn-check + .btn-preset {
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            background-color: #21262d;
            flex-grow: 1;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.6rem 0.5rem;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }
        /* Borders fix for group */
        .preset-btn-group .btn-preset:first-of-type { border-radius: 8px 0 0 8px; }
        .preset-btn-group .btn-preset:last-of-type { border-radius: 0 8px 8px 0; }
        .preset-btn-group .btn-preset:not(:last-child) { border-right: none; }

        .btn-check:checked + .btn-preset {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            z-index: 2;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        .btn-check + .btn-preset:hover {
            background-color: #30363d;
            color: white;
            z-index: 3;
        }
        
        /* Lite Button Specific */
        #presetLite:checked + .btn-preset {
            background-color: #10b981; /* Emerald */
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        /* Extreme Button Specific */
        #presetExtreme:checked + .btn-preset {
            background-color: #ef4444; /* Red */
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.8rem 3rem;
            border-radius: 50px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            color: white;
        }

        .btn-outline-custom {
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            background: var(--card-bg);
        }
        .btn-outline-custom:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
            background: #1e293b;
        }

        .spinner-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 17, 21, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(4px);
            border-radius: 8px;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .stats-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: #1e293b;
            padding: 4px 12px;
            border-radius: 4px;
            color: #94a3b8;
            border: 1px solid #334155;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .stats-badge.visible {
            opacity: 1;
        }
        .stats-highlight {
            color: #60a5fa;
            font-weight: bold;
        }
    </style>
</head>
<body class="py-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold m-0 text-white">⚡ Obfuscator <span style="color: var(--accent-primary)">Pro</span></h3>
            <small class="text-secondary">GitHub Pages Ready / Multi-Layer Protection</small>
        </div>
        <a href="https://github.com/" target="_blank" class="btn btn-outline-custom btn-sm">
            <i class="bi bi-github"></i> GitHub
        </a>
    </div>

    <div class="row g-4">
        <!-- Configuration Panel -->
        <div class="col-12">
            <div class="glass-card pb-2">
                <div class="row">
                    <!-- Presets Column -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-sliders me-1"></i> Preset Mode</div>
                        <div class="preset-btn-group mb-2">
                            <input type="radio" class="btn-check" name="preset" id="presetLite" autocomplete="off">
                            <label class="btn btn-preset" for="presetLite">Lite</label>

                            <input type="radio" class="btn-check" name="preset" id="presetMedium" autocomplete="off" checked>
                            <label class="btn btn-preset" for="presetMedium">Medium</label>

                            <input type="radio" class="btn-check" name="preset" id="presetHigh" autocomplete="off">
                            <label class="btn btn-preset" for="presetHigh">High</label>

                            <input type="radio" class="btn-check" name="preset" id="presetExtreme" autocomplete="off">
                            <label class="btn btn-preset" for="presetExtreme">Extreme</label>
                        </div>
                        <div class="small text-secondary mt-2" id="presetDesc" style="min-height: 2.5em;">
                            <!-- Description auto-filled via JS -->
                        </div>
                    </div>

                    <!-- Protection Settings -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-shield-check me-1"></i> Security</div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="optAntiDebug">
                                <label class="form-check-label" for="optAntiDebug">Anti-Debug</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="optSelfDefending">
                                <label class="form-check-label" for="optSelfDefending">Self-Defending</label>
                            </div>
                            <div class="form-check form-switch w-100">
                                <input class="form-check-input" type="checkbox" id="optDomainLock">
                                <label class="form-check-label" for="optDomainLock">Domain Lock</label>
                                <input type="text" id="domainName" class="form-control form-control-sm mt-2 bg-dark text-light border-secondary" placeholder="example.com" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <!-- Complexity Settings -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-code-square me-1"></i> Complexity</div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="optDeadCode">
                                <label class="form-check-label" for="optDeadCode">Dead Code</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="optSplitStrings">
                                <label class="form-check-label" for="optSplitStrings">Split Strings</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="optDisableConsole">
                                <label class="form-check-label" for="optDisableConsole">No Console</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="col-lg-6">
            <div class="d-flex justify-content-between mb-2 align-items-center">
                <label class="fw-bold small text-secondary">Input Source</label>
                <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary">JavaScript</span>
            </div>
            <textarea id="inputCode" class="form-control code-editor" rows="16" placeholder="// Paste your long code here..."></textarea>
        </div>

        <!-- Output Area -->
        <div class="col-lg-6 position-relative">
            <div id="processingOverlay" class="spinner-overlay" style="display: none;">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h5 class="text-white fw-bold">Processing...</h5>
                <p class="text-secondary small" id="statusText">Initializing Worker...</p>
            </div>

            <div class="d-flex justify-content-between mb-2 align-items-center">
                <label class="fw-bold small text-secondary">Obfuscated Output</label>
                <div id="sizeStats" class="stats-badge">
                    <span id="sizeOriginal">0 B</span>
                    <i class="bi bi-arrow-right mx-2" style="color: #64748b;"></i>
                    <span id="sizeObfuscated" class="stats-highlight">0 B</span>
                    <span class="ms-2" id="sizeDiff">(+0%)</span>
                </div>
            </div>
            <textarea id="outputCode" class="form-control code-editor" rows="16" readonly onclick="this.select()"></textarea>
            
            <div class="mt-3 d-flex gap-2">
                <button id="copyBtn" class="btn btn-outline-custom flex-grow-1 btn-sm">
                    <i class="bi bi-clipboard me-1"></i> Copy Result
                </button>
                <button id="testBtn" class="btn btn-outline-custom flex-grow-1 btn-sm">
                    <i class="bi bi-play-fill me-1"></i> Test Run
                </button>
            </div>
        </div>
    </div>

    <div class="text-center mt-5 mb-5">
        <button id="obfuscateBtn" class="btn btn-primary-custom btn-lg">
            <i class="bi bi-cpu-fill me-2"></i> Execute Obfuscation
        </button>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 99">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body small">
                <i class="bi bi-check-circle-fill me-2"></i> Copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Worker Script -->
<script id="worker-script" type="javascript/worker">
    importScripts(
        'https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js',
        'https://cdn.jsdelivr.net/npm/javascript-obfuscator/dist/index.browser.js',
        'https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js'
    );

    const LZ_LIB_VAR_NAME = "_lz";
    const LZSTRING_LIB_SOURCE = `var ${LZ_LIB_VAR_NAME}=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var o=i._compress(r,6,function(r){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)});switch(o.length%4){case 0:return o;case 1:return o+"===";case 2:return o+"==";case 3:return o+"="}},decompressFromBase64:function(o){return null==o?"":""==o?null:i._decompress(o.length,32,function(n){return t("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o.charAt(n))})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,a,u,c,f,s,l,p=0,h=0,d="",v="",m=2,g=3;for(i=0;i<r.length;i+=1)if(d=r.charAt(i),Object.prototype.hasOwnProperty.call(e={},d)||(e[d]=g++,t={}),v=d,Object.prototype.hasOwnProperty.call(e,d)){if(256>d.charCodeAt(0)){for(e=0;m>e;e++)p<<=1,h==o-1?(h=0,d+=n(p),p=0):h++;for(f=d.charCodeAt(0),e=0;8>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}else{for(f=1,e=0;m>e;e++)p=p<<1|f,h==o-1?(h=0,d+=n(p),p=0):h++,f=0;for(f=d.charCodeAt(0),e=0;16>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}m--,0==m&&(m=Math.pow(2,a),a++),delete e[d]}else for(f=e[v],e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(m--,0==m&&(m=Math.pow(2,a),a++),f=2,e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(;;){if(p<<=1,h==o-1){d+=n(p);break}h++}return d},_decompress:function(o,n,e){var t,i,a,u,c,f,s,l,p=[],h=4,d=4,v=3,m="",g=[],C={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)p[i]=i;for(a=0,c=Math.pow(2,2),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 2:return""}for(p[3]=l,u=l,g.push(l);;){if(C.index>o)return"";for(a=0,c=Math.pow(2,v),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(l=a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 2:return g.join("")}if(0==h&&(h=Math.pow(2,v),v++),p[l])m=p[l];else{if(l!==d)return null;m=u+u.charAt(0)}g.push(m),p[d++]=u+m.charAt(0),h--,u=m,0==h&&(h=Math.pow(2,v),v++)}}};return i}();`;

    self.onmessage = async function(e) {
        const { code, config } = e.data;
        try {
            postMessage({ type: 'status', text: 'Minifying...' });

            let codeToProcess = code;
            if (config.domainLock && config.domainName) {
                codeToProcess = `if(location.hostname!=="${config.domainName}"){throw "Unauthorized";}\n` + codeToProcess;
            }

            // Minify
            const minifiedResult = await Terser.minify(codeToProcess, {
                mangle: true,
                compress: { passes: 1, drop_console: config.disableConsole }
            });
            if (minifiedResult.error) throw minifiedResult.error;
            
            postMessage({ type: 'status', text: 'Obfuscating Logic...' });

            // Core Obfuscation
            // Liteモードの場合は stringArray を false にして容量を削減する
            const coreObfuscation = JavaScriptObfuscator.obfuscate(minifiedResult.code, {
                compact: true,
                // Flattening
                controlFlowFlattening: config.potency > 0,
                controlFlowFlatteningThreshold: config.potency, 
                // Dead Code
                deadCodeInjection: config.deadCode,
                deadCodeInjectionThreshold: config.deadCode ? (config.potency * 0.4) : 0,
                // String Array (Liteモード(=potency0)なら無効化)
                stringArray: config.stringArray,
                stringArrayEncoding: config.stringArray ? ['rc4'] : [],
                stringArrayThreshold: config.stringArray ? 0.75 : 0,
                // Misc
                numbersToExpressions: config.potency > 0.5, // Medium以上で有効化
                simplify: true,
                splitStrings: config.splitStrings,
                splitStringsChunkLength: 10,
                debugProtection: config.antiDebug,
                debugProtectionInterval: config.antiDebug ? 4000 : 0,
                disableConsoleOutput: config.disableConsole,
                selfDefending: config.selfDefending
            }).getObfuscatedCode();

            postMessage({ type: 'status', text: 'Compressing & Wrapping...' });

            const compressedPayload = LZString.compressToBase64(coreObfuscation);

            const wrapperCode = `
/* javascript-obfuscator:disable */
${LZSTRING_LIB_SOURCE}
/* javascript-obfuscator:enable */
var payload = "${compressedPayload}";
var decompressed = ${LZ_LIB_VAR_NAME}.decompressFromBase64(payload);
(0, eval)(decompressed);
            `;

            // Final Shell Obfuscation
            // Liteモードでも外殻は少し難読化するが、サイズ重視設定にする
            const finalResult = JavaScriptObfuscator.obfuscate(wrapperCode, {
                compact: true,
                identifierNamesGenerator: 'mangled',
                renameGlobals: false,
                unicodeEscapeSequence: config.potency > 0, // LiteならOFFでサイズ節約
                stringArray: config.stringArray,
                stringArrayEncoding: config.stringArray ? ['rc4'] : [],
                stringArrayThreshold: config.stringArray ? 1 : 0,
                splitStrings: true,
                splitStringsChunkLength: config.potency > 0 ? 15 : 0
            }).getObfuscatedCode();

            postMessage({ type: 'success', result: finalResult });

        } catch (err) {
            postMessage({ type: 'error', message: err.message });
        }
    };
</script>

<script>
    // --- Presets Configuration ---
    const PRESETS = {
        lite: {
            potency: 0,            // Flattening OFF
            stringArray: false,    // String Array OFF (Size Saver)
            antiDebug: false,
            selfDefending: false,
            deadCode: false,
            splitStrings: false,
            disableConsole: false,
            desc: "Lite Mode: Minify + Compression only. Best for large files. (Size: ~1.0x-1.3x)"
        },
        medium: {
            potency: 0.4,
            stringArray: true,
            antiDebug: true,
            selfDefending: true,
            deadCode: false,
            splitStrings: false,
            disableConsole: true,
            desc: "Medium Mode: Balanced obfuscation. Good for general use."
        },
        high: {
            potency: 0.75,
            stringArray: true,
            antiDebug: true,
            selfDefending: true,
            deadCode: true,
            splitStrings: true,
            disableConsole: true,
            desc: "High Mode: Strong protection with dead code injection."
        },
        extreme: {
            potency: 1.0,
            stringArray: true,
            antiDebug: true,
            selfDefending: true,
            deadCode: true,
            splitStrings: true,
            disableConsole: true,
            desc: "Extreme Mode: Max complexity. May impact performance."
        }
    };

    let currentConfig = { ...PRESETS.medium };

    // Apply Preset Logic
    function applyPreset(presetName) {
        const p = PRESETS[presetName];
        if (!p) return;

        // Update UI
        document.getElementById('optAntiDebug').checked = p.antiDebug;
        document.getElementById('optSelfDefending').checked = p.selfDefending;
        document.getElementById('optDeadCode').checked = p.deadCode;
        document.getElementById('optSplitStrings').checked = p.splitStrings;
        document.getElementById('optDisableConsole').checked = p.disableConsole;
        document.getElementById('presetDesc').innerText = p.desc;
        
        // Store Config
        currentConfig = { ...p };
    }

    // Event Listeners for Preset Buttons
    document.querySelectorAll('input[name="preset"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const presetKey = e.target.id.replace('preset', '').toLowerCase();
            applyPreset(presetKey);
        });
    });

    // Initialize
    applyPreset('medium');

    // UI Logic
    document.getElementById('optDomainLock').addEventListener('change', function(e) {
        document.getElementById('domainName').style.display = e.target.checked ? 'block' : 'none';
    });

    function formatBytes(bytes, decimals = 1) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function getByteSize(str) {
        return new Blob([str]).size;
    }

    let worker = null;

    function createWorker() {
        const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
        return new Worker(window.URL.createObjectURL(blob));
    }

    document.getElementById('obfuscateBtn').addEventListener('click', () => {
        const input = document.getElementById('inputCode').value;
        const outputArea = document.getElementById('outputCode');
        const overlay = document.getElementById('processingOverlay');
        const statusText = document.getElementById('statusText');
        const statsBadge = document.getElementById('sizeStats');

        // 実行時の設定値収集（UIの現在の状態を優先）
        const runConfig = {
            potency: currentConfig.potency,
            stringArray: currentConfig.stringArray, // プリセットから取得
            antiDebug: document.getElementById('optAntiDebug').checked,
            selfDefending: document.getElementById('optSelfDefending').checked,
            domainLock: document.getElementById('optDomainLock').checked,
            domainName: document.getElementById('domainName').value.trim(),
            deadCode: document.getElementById('optDeadCode').checked,
            splitStrings: document.getElementById('optSplitStrings').checked,
            disableConsole: document.getElementById('optDisableConsole').checked,
        };

        if (!input.trim()) {
            alert("Please enter JavaScript code.");
            return;
        }

        outputArea.value = "";
        overlay.style.display = 'flex';
        statusText.innerText = "Initializing...";
        statsBadge.classList.remove('visible');

        if (worker) worker.terminate();
        worker = createWorker();

        worker.postMessage({ code: input, config: runConfig });

        worker.onmessage = function(e) {
            const data = e.data;

            if (data.type === 'status') {
                statusText.innerText = data.text;
            } else if (data.type === 'success') {
                outputArea.value = data.result;
                overlay.style.display = 'none';
                
                const originalSize = getByteSize(input);
                const resultSize = getByteSize(data.result);
                const diffPercent = ((resultSize - originalSize) / originalSize * 100).toFixed(0);
                
                document.getElementById('sizeOriginal').innerText = formatBytes(originalSize);
                document.getElementById('sizeObfuscated').innerText = formatBytes(resultSize);
                
                const diffElem = document.getElementById('sizeDiff');
                // Liteモード等はマイナスになる可能性もあるため色分け
                if (resultSize > originalSize) {
                    diffElem.innerText = `(+${diffPercent}%)`;
                    diffElem.style.color = '#ef4444';
                } else {
                    diffElem.innerText = `(${diffPercent}%)`;
                    diffElem.style.color = '#10b981'; // Emerald for shrink
                }
                statsBadge.classList.add('visible');

                worker.terminate();
                worker = null;
            } else if (data.type === 'error') {
                console.error(data.message);
                outputArea.value = "Error: " + data.message;
                overlay.style.display = 'none';
                worker.terminate();
                worker = null;
            }
        };
    });

    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
    document.getElementById('copyBtn').addEventListener('click', () => {
        const val = document.getElementById('outputCode').value;
        if(val) navigator.clipboard.writeText(val).then(() => toast.show());
    });

    document.getElementById('testBtn').addEventListener('click', () => {
        const code = document.getElementById('outputCode').value;
        if(!code) return;
        if(confirm("Execute code in this browser tab?")) {
            try { (0, eval)(code); } catch(e) { alert("Error: " + e); }
        }
    });
</script>

</body>
</html>
