<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« [Final Fix]</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #050505; color: #0f0; padding: 20px; }
    .container { max-width: 1100px; margin: auto; background: #000; padding: 30px; border-radius: 8px; border: 1px solid #0f0; }
    textarea, #output { width: 100%; background: #111; color: #0f0; border: 1px solid #333; padding: 15px; box-sizing: border-box; height: 180px; font-size: 14px; }
    textarea:focus, #output:focus { outline: none; border-color: #0f0; }
    #output { min-height: 200px; white-space: pre-wrap; word-break: break-all; color: #cfc; opacity: 0.9; }
    .controls { display: flex; gap: 15px; justify-content: center; margin: 25px 0; }
    button { padding: 12px 24px; background: #002200; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; }
    button:hover { background: #004400; }
    .options { background: #0a0a0a; padding: 15px; border: 1px solid #333; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom:20px; }
    .status-bar { border-top: 1px dashed #333; padding-top: 15px; text-align: center; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« <span style="font-size:0.6em; color:#fa0;">[Final Fix]</span></h1>
    <p style="text-align:center; color:#8f8; font-size:0.9em;">æ•°å€¤ã‚«ãƒƒã‚³æ’é™¤ / ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ / æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«å¯¾ç­–æ¸ˆã¿</p>

    <textarea id="input" placeholder="// ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›&#13;&#10;const data = { 200: 'OK', 404: 'Not Found' };&#13;&#10;var regex = /&quot;/g;&#13;&#10;console.log(data[200]);">
// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
var config = { 
  10: "Low", 
  20: "High" 
};
var text = "ã“ã‚Œã¯\"ãƒ†ã‚¹ãƒˆ\"ã§ã™";
var reg = /"/g; // æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«å†…ã®ã‚¯ã‚©ãƒ¼ãƒˆå¯¾ç­–

console.log(config[10]);
if(100 > 50) {
  alert(text.replace(reg, "'"));
}
</textarea>

    <div class="options">
      <div><strong>å±¤æ•°: <input type="range" id="layers" min="1" max="3" value="1"> <span id="layerVal">1</span></strong></div>
      <label><input type="checkbox" id="stripComments" checked disabled> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ (å¿…é ˆ)</label>
      <label><input type="checkbox" id="renameVars" checked> å¤‰æ•°åãƒªãƒãƒ¼ãƒ </label>
      <label><input type="checkbox" id="stringEscape" checked> æ–‡å­—åˆ—é›£èª­åŒ–</label>
      <label><input type="checkbox" id="numberSafe" checked> æ•°å€¤HexåŒ– (å®‰å…¨)</label>
      <label><input type="checkbox" id="wrapEval" checked> Evalåœ§ç¸®</label>
    </div>

    <div class="controls">
      <button onclick="processObfuscation()">ğŸ’€ é›£èª­åŒ–å®Ÿè¡Œ</button>
      <button onclick="copyToClip()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      <button onclick="runTest()" style="border-color:#f55; color:#fcc;">ğŸš¨ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="status-bar">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="statusText">å¾…æ©Ÿä¸­</span></div>
    <pre id="output"></pre>
  </div>

<script>
let finalCode = "";

/**
 * æ­£è¦è¡¨ç¾å®šæ•°
 */
// æ–‡å­—åˆ—ï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒ»ãƒ€ãƒ–ãƒ«ãƒ»ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆå…¨éƒ¨ï¼‰
// ãŸã ã—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«å†…ã®ãƒã‚¹ãƒˆã¾ã§ã¯å®Œç’§ã«ã¯è¿½ãˆãªã„ãŒã€é€šå¸¸ã®æ–‡å­—åˆ—ã¯ã“ã‚Œã§OK
const STRING_REGEX = /((['"`])(?:\\.|[^\\])*?\2)/g;

// æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«ï¼ˆç°¡æ˜“ï¼‰: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã§å›²ã¾ã‚Œã€æ”¹è¡Œã‚’å«ã¾ãªã„ã‚‚ã®
// â€»é™¤ç®—(/)ã¨ã®èª¤çˆ†ã‚’é˜²ãã®ã¯é›£ã—ã„ãŒã€å…¸å‹çš„ãªãƒªãƒ†ãƒ©ãƒ« /.../g ã‚’ä¿è­·ã™ã‚‹
const REGEX_LITERAL = /\/((?:\\.|[^\\\r\n])+?)\/[gimsuy]*/g;

function obfuscateOnce(sourceCode) {
  let code = sourceCode;
  const stringStore = [];

  // ----------------------------------------------------------
  // 0. ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ (è§£æã®é‚ªé­”ã«ãªã‚‹ãŸã‚å¿…é ˆ)
  // ----------------------------------------------------------
  // ãƒ–ãƒ­ãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆ
  code = code.replace(/\/\*[\s\S]*?\*\//g, "");
  // è¡Œã‚³ãƒ¡ãƒ³ãƒˆ (URLã® http:// ã‚’æ¶ˆã•ãªã„ã‚ˆã†ã«æ³¨æ„ãŒå¿…è¦ã ãŒã€ç°¡æ˜“çš„ã«è¡Œé ­ã‚„ã‚¹ãƒšãƒ¼ã‚¹å¾Œã® // ã‚’æ¶ˆã™)
  code = code.replace(/([^:]|^)\/\/.*$/gm, "$1");


  // ----------------------------------------------------------
  // 1. æ–‡å­—åˆ— & æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«ã®ä¿è­· (ãƒã‚¹ã‚¯)
  // ----------------------------------------------------------
  
  // å…ˆã«æ–‡å­—åˆ—ã‚’ãƒã‚¹ã‚¯ã™ã‚‹
  code = code.replace(STRING_REGEX, (match) => {
    const placeholder = `___STR_${stringStore.length}___`;
    stringStore.push(match);
    return placeholder;
  });

  // ----------------------------------------------------------
  // 2. å¤‰æ•°åãƒªãƒãƒ¼ãƒ 
  // ----------------------------------------------------------
  if (document.getElementById('renameVars').checked) {
    const varMap = {};
    let varCount = 0;
    // å£Šã™ã¨ã¾ãšã„ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¯é™¤å¤–
    const exclude = ['window', 'document', 'console', 'alert', 'eval', 'JSON', 'Math', 'parseInt', 'setTimeout', 'setInterval', 'location', 'history', 'String', 'Number', 'Array', 'Object'];

    code = code.replace(/\b(var|let|const|function)\s+([a-zA-Z_$][\w$]*)/g, (m, type, name) => {
      if (exclude.includes(name)) return m;
      if (!varMap[name]) {
        // è­˜åˆ¥å­ã¨ã—ã¦å®‰å…¨ãªæ–‡å­—ã®ã¿ã‚’ä½¿ç”¨
        varMap[name] = `_0x${Math.floor(Math.random()*0xffff).toString(16)}_${varCount++}`;
      }
      return `${type} ${varMap[name]}`;
    });

    // ç½®æ›å®Ÿè¡Œ
    for (const [orig, neo] of Object.entries(varMap)) {
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¢ƒç•Œã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
      const re = new RegExp(`(?<!\\.|[a-zA-Z0-9_$])${orig}\\b`, 'g');
      code = code.replace(re, neo);
    }
  }

  // ----------------------------------------------------------
  // 3. æ•°å€¤é›£èª­åŒ– (Unexpected token fix)
  // ----------------------------------------------------------
  if (document.getElementById('numberSafe').checked) {
    // ãƒã‚¹ã‚¯ã•ã‚ŒãŸæ–‡å­—åˆ—(STR_0)å†…ã®æ•°å­—ã‚’å·»ãè¾¼ã¾ãªã„ã‚ˆã†ãƒã‚§ãƒƒã‚¯
    code = code.replace(/\b(\d+)\b/g, (match) => {
      // ã‚‚ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®ä¸€éƒ¨ãªã‚‰ç„¡è¦– (ç°¡æ˜“ãƒã‚§ãƒƒã‚¯)
      if (code.includes(`___STR_${match}___`)) return match;
      // æ—¢ã«Hexãªã‚‰ç„¡è¦–
      if (code.substring(code.indexOf(match)-2, code.indexOf(match)) === '0x') return match;

      const n = parseInt(match, 10);
      if (isNaN(n)) return match;
      if (match.startsWith('0') && match.length > 1) return match; // 0å§‹ã¾ã‚Šã¯ç„¡è¦–
      if (n < 10) return match; 

      // ã€é‡è¦ä¿®æ­£ã€‘ã‚«ãƒƒã‚³ã‚„è¨ˆç®—å¼ã‚’ä½¿ã‚ãšã€ç´”ç²‹ãªHexãƒªãƒ†ãƒ©ãƒ«ã«ã™ã‚‹
      // ã“ã‚Œãªã‚‰ { 0x10: "val" } ã¨ãªã‚Šæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
      return `0x${n.toString(16)}`; 
    });
  }

  // ----------------------------------------------------------
  // 4. æ–‡å­—åˆ—å¾©å…ƒ & ä¸­èº«ã®é›£èª­åŒ–
  // ----------------------------------------------------------
  code = code.replace(/___STR_(\d+)___/g, (match, index) => {
    let originalStr = stringStore[parseInt(index)];
    
    // æ–‡å­—åˆ—é›£èª­åŒ–ãŒOFFãªã‚‰ãã®ã¾ã¾æˆ»ã™
    if (!document.getElementById('stringEscape').checked) return originalStr;

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«(`)ã‚„æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«(/)ã¯ä¸­èº«ã‚’ã„ã˜ã‚‹ã¨å£Šã‚Œã‚‹ã®ã§ãã®ã¾ã¾æˆ»ã™
    const firstChar = originalStr[0];
    if (firstChar === '`' || firstChar === '/') return originalStr;

    // é€šå¸¸ã®æ–‡å­—åˆ— (" or ')
    const quote = firstChar;
    const content = originalStr.slice(1, -1);
    
    let obfuscated = "";
    for (let i = 0; i < content.length; i++) {
      const c = content.charCodeAt(i);
      const char = content[i];
      
      // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯æ—¢ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ã‚‹ã®ã§è§¦ã‚‰ãªã„
      if (char === '\\') {
        obfuscated += char + (content[i+1] || '');
        i++; 
        continue;
      }

      // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚„è¨˜å·ã‚’HexåŒ–
      if (Math.random() > 0.5 && c > 31 && c < 127) {
        obfuscated += '\\x' + c.toString(16).padStart(2, '0');
      } else {
        obfuscated += char;
      }
    }
    return quote + obfuscated + quote;
  });

  // ----------------------------------------------------------
  // 5. Evalåœ§ç¸® (JSON.stringifyã§å®‰å…¨åŒ–)
  // ----------------------------------------------------------
  if (document.getElementById('wrapEval').checked) {
    code = `eval(${JSON.stringify(code)})`;
  }

  return code;
}

function processObfuscation() {
  const input = document.getElementById('input').value;
  if (!input.trim()) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
  
  const status = document.getElementById('statusText');
  status.textContent = "å‡¦ç†ä¸­...";
  
  setTimeout(() => {
    try {
      let c = input;
      const layers = parseInt(document.getElementById('layers').value);
      for(let i=0; i<layers; i++) {
        c = obfuscateOnce(c);
      }
      
      finalCode = c;
      document.getElementById('output').textContent = finalCode;
      status.textContent = "âœ… å®Œäº†";
      status.style.color = "#0f0";
    } catch(e) {
      alert("ã‚¨ãƒ©ãƒ¼: " + e);
      status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
      status.style.color = "#f55";
    }
  }, 50);
}

function runTest() {
  if(!finalCode) return;
  try {
    // ãƒ­ã‚°ä¹—ã£å–ã‚Š
    const originalLog = console.log;
    let logs = "";
    console.log = (...a) => { logs += a.join(' ') + "\n"; originalLog.apply(console, a); };
    
    // å®Ÿè¡Œ
    new Function(finalCode)();
    
    console.log = originalLog;
    
    if (logs) alert("å®Ÿè¡ŒæˆåŠŸï¼ãƒ­ã‚°:\n" + logs);
    else alert("å®Ÿè¡ŒæˆåŠŸï¼ï¼ˆãƒ­ã‚°å‡ºåŠ›ãªã—ï¼‰");
    
  } catch(e) {
    alert("å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: " + e.message);
  }
}

function copyToClip() {
  if(!finalCode) return;
  navigator.clipboard.writeText(finalCode);
  document.getElementById('statusText').textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
}

document.getElementById('layers').addEventListener('input', e => document.getElementById('layerVal').textContent = e.target.value);
</script>
</body>
</html>
