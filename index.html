<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« [Final Stable]</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #050505; color: #0f0; padding: 20px; }
    .container { max-width: 1100px; margin: auto; background: #000; padding: 30px; border-radius: 8px; border: 1px solid #0f0; }
    textarea, #output { width: 100%; background: #111; color: #0f0; border: 1px solid #333; border-radius: 4px; padding: 15px; box-sizing: border-box; height: 150px; }
    textarea:focus, #output:focus { outline: none; border-color: #0f0; }
    #output { min-height: 200px; white-space: pre-wrap; word-break: break-all; color: #cfc; opacity: 0.9; }
    .controls { display: flex; gap: 15px; justify-content: center; margin: 25px 0; }
    button { padding: 12px 24px; background: #002200; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
    button:hover { background: #004400; }
    .options { background: #0a0a0a; padding: 15px; border: 1px solid #333; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom:20px; }
    .status-bar { border-top: 1px dashed #333; padding-top: 15px; text-align: center; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« <span style="font-size:0.6em">[Final Stable]</span></h1>
    <p style="text-align:center; color:#8f8; font-size:0.9em;">ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚­ãƒ¼ä¿è­·ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«å¯¾å¿œç‰ˆ</p>

    <textarea id="input" placeholder="// ã‚³ãƒ¼ãƒ‰å…¥åŠ›&#13;&#10;const config = { 100: 'data' };&#13;&#10;var name = 'User';&#13;&#10;console.log(`Hello ${name}`);">
var magic = 123;
var obj = { 
  404: "Not Found",
  data: "Secret"
};
console.log(`Code: ${magic}, Status: ${obj[404]}`);
</textarea>

    <div class="options">
      <div><strong>å±¤æ•°: <input type="range" id="layers" min="1" max="3" value="1"> <span id="layerVal">1</span></strong></div>
      <label><input type="checkbox" id="renameVars" checked> å¤‰æ•°åãƒªãƒãƒ¼ãƒ </label>
      <label><input type="checkbox" id="stringEscape" checked> æ–‡å­—åˆ—é›£èª­åŒ–</label>
      <label><input type="checkbox" id="numberSafe" checked> æ•°å€¤é›£èª­åŒ–</label>
      <label><input type="checkbox" id="wrapEval" checked> Evalåœ§ç¸® (JSON)</label>
    </div>

    <div class="controls">
      <button onclick="processObfuscation()">ğŸ’€ é›£èª­åŒ–å®Ÿè¡Œ</button>
      <button onclick="copyToClip()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      <button onclick="runTest()" style="border-color:#f55; color:#fcc;">ğŸš¨ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="status-bar">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="statusText">å¾…æ©Ÿä¸­</span></div>
    <pre id="output"></pre>
  </div>

<script>
let finalCode = "";

// ã€é‡è¦ä¿®æ­£ 1ã€‘ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ« (`) ã¯ãƒã‚¹ã‚¯ã—ãªã„ï¼
// ã“ã‚Œã«ã‚ˆã‚Š `${variable}` ã®ä¸­èº«ãŒæ­£ã—ããƒªãƒãƒ¼ãƒ å¯¾è±¡ã«ãªã‚‹
// æ­£è¦è¡¨ç¾: ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ(") ã¾ãŸã¯ ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ(') ã®ã¿ã‚’å¯¾è±¡
const STRING_REGEX = /((['"])(?:\\.|[^\\])*?\2)/g;

function obfuscateOnce(sourceCode) {
  let code = sourceCode;
  const stringStore = [];

  // 1. æ–‡å­—åˆ—ä¿è­·ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆæ–‡å­—ã®ã¿ï¼‰
  code = code.replace(STRING_REGEX, (match) => {
    const placeholder = `___STR_${stringStore.length}___`;
    stringStore.push(match);
    return placeholder;
  });

  // 2. å¤‰æ•°åãƒªãƒãƒ¼ãƒ 
  if (document.getElementById('renameVars').checked) {
    const varMap = {};
    let varCount = 0;
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«æ±šæŸ“ã‚’é¿ã‘ã‚‹ãŸã‚é™¤å¤–ãƒªã‚¹ãƒˆã‚’å°‘ã—åºƒã‚ã«
    const exclude = ['window', 'document', 'console', 'alert', 'eval', 'JSON', 'Math', 'parseInt', 'setTimeout', 'location', 'history'];

    // å®£è¨€ã®æ¤œå‡º
    code = code.replace(/\b(var|let|const|function)\s+([a-zA-Z_$][\w$]*)/g, (m, type, name) => {
      if (exclude.includes(name)) return m;
      if (!varMap[name]) {
        varMap[name] = `_0x${Math.floor(Math.random()*0xffff).toString(16)}_${varCount++}`;
      }
      return `${type} ${varMap[name]}`;
    });

    // ç½®æ›å®Ÿè¡Œ
    for (const [orig, neo] of Object.entries(varMap)) {
      // ã€é‡è¦ä¿®æ­£ 2ã€‘ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚­ãƒ¼ç ´å£Šé˜²æ­¢ (?!\s*:)
      // å¤‰æ•°åã®ç›´å¾Œã«ã‚³ãƒ­ãƒ³ãŒã‚ã‚‹å ´åˆï¼ˆ{ key: val } ã‚„ case key:ï¼‰ã¯ç½®æ›ã—ãªã„
      const re = new RegExp(`(?<!\\.|[a-zA-Z0-9_$])${orig}\\b(?!\\s*:)`, 'g');
      code = code.replace(re, neo);
    }
  }

  // 3. æ•°å€¤é›£èª­åŒ–
  if (document.getElementById('numberSafe').checked) {
    // ã€é‡è¦ä¿®æ­£ 3ã€‘ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚­ãƒ¼ç ´å£Šé˜²æ­¢ (?!\s*:)
    // 123: value ã®ã‚ˆã†ãªã‚­ãƒ¼ã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹æ•°å€¤ã¯å¤‰æ›´ã—ãªã„
    code = code.replace(/\b(\d+)\b(?!\\s*:)/g, (match) => {
      // ãƒã‚¹ã‚¯æ–‡å­—åˆ—å†…ã®æ•°å­—(STR_0)ã¯ç„¡è¦–
      if(sourceCode.includes(`___STR_${match}___`) && code.includes(`___STR_${match}___`)) return match;
      
      const n = parseInt(match, 10);
      if (match.startsWith('0') && match.length > 1) return match; 
      if (n < 10) return match; 

      const methods = [
        `0x${n.toString(16)}`, 
        `(0x${n.toString(16)}|0)`
      ];
      return methods[Math.floor(Math.random() * methods.length)];
    });
  }

  // 4. æ–‡å­—åˆ—å¾©å…ƒ
  code = code.replace(/___STR_(\d+)___/g, (match, index) => {
    let originalStr = stringStore[parseInt(index)];
    if (!document.getElementById('stringEscape').checked) return originalStr;
    
    const quote = originalStr[0];
    const content = originalStr.slice(1, -1);
    let obfuscated = "";
    for (let i = 0; i < content.length; i++) {
      const c = content.charCodeAt(i);
      // å®‰å…¨ãªç¯„å›²ã®ã¿ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      if (Math.random() > 0.5 && c > 31 && c < 127 && content[i] !== '\\') {
        obfuscated += '\\x' + c.toString(16).padStart(2, '0');
      } else {
        obfuscated += content[i];
      }
    }
    return quote + obfuscated + quote;
  });

  // 5. Evalåœ§ç¸®
  if (document.getElementById('wrapEval').checked) {
    code = `eval(${JSON.stringify(code)})`;
  }

  return code;
}

function processObfuscation() {
  const input = document.getElementById('input').value;
  if (!input.trim()) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
  
  document.getElementById('statusText').textContent = "å‡¦ç†ä¸­...";
  
  setTimeout(() => {
    try {
      let c = input;
      const layers = parseInt(document.getElementById('layers').value);
      for(let i=0; i<layers; i++) c = obfuscateOnce(c);
      
      finalCode = c;
      document.getElementById('output').textContent = finalCode;
      document.getElementById('statusText').textContent = "âœ… å®Œäº†";
      document.getElementById('statusText').style.color = "#0f0";
    } catch(e) {
      alert("ã‚¨ãƒ©ãƒ¼: " + e);
    }
  }, 10);
}

function runTest() {
  if(!finalCode) return;
  try {
    const log = console.log;
    let logs = "";
    console.log = (...a) => { logs += a.join(' ') + "\n"; log(...a); };
    new Function(finalCode)();
    console.log = log;
    alert("å®Ÿè¡ŒæˆåŠŸ:\n" + logs);
  } catch(e) {
    alert("å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: " + e.message);
  }
}

function copyToClip() {
  navigator.clipboard.writeText(finalCode);
  document.getElementById('statusText').textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
}

document.getElementById('layers').addEventListener('input', e => document.getElementById('layerVal').textContent = e.target.value);
</script>
</body>
</html>
