<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« [é«˜å®‰å®šç‰ˆ]</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #050505; color: #0f0; padding: 20px; line-height: 1.6; }
    .container { max-width: 1100px; margin: auto; background: #000; padding: 30px; border-radius: 10px; border: 1px solid #0f0; box-shadow: 0 0 20px #003300; }
    h1 { text-align: center; color: #fff; text-shadow: 0 0 10px #0f0; font-size: 2em; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #8f8; font-size: 0.9em; margin-bottom: 30px; }
    textarea, #output { width: 100%; background: #111; color: #0f0; border: 1px solid #333; border-radius: 4px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; box-sizing: border-box; }
    textarea { height: 150px; border-left: 3px solid #0f0; }
    textarea:focus, #output:focus { outline: none; border-color: #0f0; }
    #output { min-height: 250px; white-space: pre-wrap; word-break: break-all; opacity: 0.9; color: #cfc; }
    
    .controls { display: flex; gap: 15px; justify-content: center; margin: 25px 0; }
    button { padding: 12px 24px; font-weight:bold; font-size: 16px; background: #002200; color: #0f0; border: 1px solid #0f0; cursor: pointer; transition: 0.2s; }
    button:hover { background: #004400; box-shadow: 0 0 10px #0f0; }
    
    .options { background: #0a0a0a; padding: 20px; border: 1px solid #333; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom:20px;}
    label { display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 14px; }
    input[type="checkbox"] { margin-right: 8px; accent-color: #0f0; }
    
    .status-bar { margin-top: 20px; padding: 15px; border-top: 1px dashed #333; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›‘ å¤šå±¤é›£èª­åŒ–ãƒ„ãƒ¼ãƒ« <span style="font-size:0.6em; color:#888;">[é«˜å®‰å®šç‰ˆ]</span></h1>
    <p class="subtitle">æ–‡å­—åˆ—ãƒã‚¹ã‚¯å‡¦ç†ã«ã‚ˆã‚Š "Invalid escape" ã‚¨ãƒ©ãƒ¼ã‚’æ ¹çµ¶</p>

    <textarea id="input" placeholder="// ã“ã“ã«JSã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›&#13;&#10;var text = 'Say \"Hello\"';&#13;&#10;alert(text);">
var secret = 123;
var msg = "ã‚¨ãƒ©ãƒ¼ã¯\"çµ¶å¯¾ã«\"è¨±ã•ãªã„";
console.log(msg, secret * 2);
if(secret > 100) {
  alert('æˆåŠŸã§ã™: ' + msg);
}
</textarea>

    <div class="options">
      <div>
        <strong>å±¤æ•°: <input type="range" id="layers" min="1" max="5" value="2"> <span id="layerVal">2</span></strong>
        <br><span style="font-size:11px; color:#888;">â€»3å±¤ä»¥ä¸Šã¯å®Ÿè¡Œé€Ÿåº¦ã«å½±éŸ¿ã—ã¾ã™</span>
      </div>
      <label><input type="checkbox" id="renameVars" checked> å¤‰æ•°åãƒªãƒãƒ¼ãƒ  (ãƒã‚¹ã‚¯å‡¦ç†ä»˜)</label>
      <label><input type="checkbox" id="stringEscape" checked> æ–‡å­—åˆ—é›£èª­åŒ– (\xHH)</label>
      <label><input type="checkbox" id="numberSafe" checked> æ•°å€¤é›£èª­åŒ– (HexåŒ–)</label>
      <label><input type="checkbox" id="deadCode" checked> ãƒ€ãƒŸãƒ¼ã‚³ãƒ¼ãƒ‰æŒ¿å…¥</label>
      <label><input type="checkbox" id="wrapEval" checked> Evalåœ§ç¸® (JSONå½¢å¼)</label>
    </div>

    <div class="controls">
      <button onclick="processObfuscation()">ğŸ’€ é›£èª­åŒ–å®Ÿè¡Œ</button>
      <button onclick="copyToClip()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      <button onclick="runTest()" style="border-color:#f55; color:#fcc;">ğŸš¨ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="status-bar">
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="statusText" style="color:#888">å¾…æ©Ÿä¸­</span>
    </div>

    <pre id="output">// çµæœã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</pre>
  </div>

<script>
let finalCode = "";

/**
 * æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã‚’å®‰å…¨ã«æŠ½å‡ºã™ã‚‹ãŸã‚ã®æ­£è¦è¡¨ç¾
 * å¯¾å¿œ: "...", '...', `...` ãŠã‚ˆã³å†…éƒ¨ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ \" \' \\
 */
const STRING_REGEX = /((['"`])(?:\\.|[^\\])*?\2)/g;

/**
 * 1å±¤åˆ†ã®é›£èª­åŒ–å‡¦ç†
 */
function obfuscateOnce(sourceCode) {
  let code = sourceCode;
  
  // ----------------------------------------------------------
  // Step 0: æ–‡å­—åˆ—ã®ä¿è­· (ãƒã‚¹ã‚­ãƒ³ã‚°)
  // ã‚³ãƒ¼ãƒ‰ä¸­ã®æ–‡å­—åˆ—ã‚’ä¸€æ™‚çš„ã« __STR_0__, __STR_1__ ã«ç½®ãæ›ãˆã‚‹ã€‚
  // ã“ã‚Œã«ã‚ˆã‚Šã€å¤‰æ•°åãƒªãƒãƒ¼ãƒ ãªã©ã§æ–‡å­—åˆ—ã®ä¸­èº«ãŒå£Šã‚Œã‚‹ã®ã‚’é˜²ãã€‚
  // ----------------------------------------------------------
  const stringStore = [];
  code = code.replace(STRING_REGEX, (match) => {
    const placeholder = `___STR_${stringStore.length}___`;
    stringStore.push(match);
    return placeholder;
  });

  // ----------------------------------------------------------
  // Step 1: å¤‰æ•°åãƒªãƒãƒ¼ãƒ 
  // ----------------------------------------------------------
  if (document.getElementById('renameVars').checked) {
    const varMap = {};
    let varCount = 0;
    const exclude = ['window', 'document', 'console', 'alert', 'eval', 'JSON', 'Math', 'parseInt', 'location'];
    
    // å¤‰æ•°å®£è¨€ã‚’è¦‹ã¤ã‘ã‚‹ (æ–‡å­—åˆ—ã¯ãƒã‚¹ã‚¯ã•ã‚Œã¦ã„ã‚‹ã®ã§èª¤çˆ†ã—ãªã„)
    code = code.replace(/\b(var|let|const|function)\s+([a-zA-Z_$][\w$]*)/g, (m, type, name) => {
      if (exclude.includes(name)) return m;
      if (!varMap[name]) {
        // 16é€²æ•°ã‚’ä½¿ã£ãŸãƒ©ãƒ³ãƒ€ãƒ ãªå¤‰æ•°å
        const rnd = Math.floor(Math.random() * 0xffff).toString(16);
        varMap[name] = `_0x${rnd}_${varCount++}`;
      }
      return `${type} ${varMap[name]}`;
    });

    // ç½®æ›å®Ÿè¡Œ (ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ .name ã¯é¿ã‘ã‚‹)
    for (const [orig, neo] of Object.entries(varMap)) {
      // (?<!\.) -> ç›´å‰ã«ãƒ‰ãƒƒãƒˆãŒãªã„
      // \b -> å˜èªå¢ƒç•Œ
      const re = new RegExp(`(?<!\\.|[a-zA-Z0-9_$])${orig}\\b`, 'g');
      code = code.replace(re, neo);
    }
  }

  // ----------------------------------------------------------
  // Step 2: æ•°å€¤é›£èª­åŒ–
  // ----------------------------------------------------------
  if (document.getElementById('numberSafe').checked) {
    // ãƒã‚¹ã‚¯ã•ã‚ŒãŸæ–‡å­—åˆ—ä»¥å¤–ã®å ´æ‰€ã«ã‚ã‚‹æ•°å€¤ã‚’æ¤œç´¢
    code = code.replace(/\b(\d+)\b/g, (match) => {
      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®ä¸­ã®æ•°å­—(STR_0ãªã©)ã‚’ã„ã˜ã‚‰ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
      // (Step 0ã®ãƒã‚¹ã‚¯å½¢å¼ã«ä¾å­˜)
      const n = parseInt(match, 10);
      if (match.startsWith('0') && match.length > 1) return match; // 8é€²æ•°ã£ã½ã„ã‚„ã¤ã¯ç„¡è¦–
      if (n < 10) return match; // å°ã•ã„æ•°ã¯ãã®ã¾ã¾

      const methods = [
        `0x${n.toString(16)}`, // Hex
        `(0x${n.toString(16)}|0)` // Bitwise
      ];
      return methods[Math.floor(Math.random() * methods.length)];
    });
  }

  // ----------------------------------------------------------
  // Step 3: ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰æŒ¿å…¥
  // ----------------------------------------------------------
  if (document.getElementById('deadCode').checked) {
    const dummyVar = `_0x${Math.random().toString(36).slice(2,6)}`;
    const dead = `var ${dummyVar}=${Math.floor(Math.random()*100)};if(${dummyVar}>200)${dummyVar}=0;`;
    code = dead + "\n" + code;
  }

  // ----------------------------------------------------------
  // Step 4: æ–‡å­—åˆ—ã®å¾©å…ƒ (ã‚¢ãƒ³ãƒã‚¹ã‚¯) ï¼† æ–‡å­—åˆ—è‡ªä½“ã®é›£èª­åŒ–
  // ----------------------------------------------------------
  const doStringEscape = document.getElementById('stringEscape').checked;
  
  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å…ƒã®æ–‡å­—åˆ—ã«æˆ»ã™
  // ã“ã®æ™‚ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒONãªã‚‰ä¸­èº«ã‚’ \xHH å½¢å¼ã«å¤‰æ›ã™ã‚‹
  code = code.replace(/___STR_(\d+)___/g, (match, index) => {
    let originalStr = stringStore[parseInt(index)];
    
    if (!doStringEscape) return originalStr;

    // ã‚¯ã‚©ãƒ¼ãƒˆã®ç¨®é¡ã‚’å–å¾— (' " `)
    const quote = originalStr[0];
    const content = originalStr.slice(1, -1);
    
    // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ï¼‰ã¯è¤‡é›‘ãªã®ã§è§¦ã‚‰ãªã„ã®ãŒå®‰å…¨
    if (quote === '`') return originalStr;

    let obfuscatedContent = "";
    for (let i = 0; i < content.length; i++) {
      const charCode = content.charCodeAt(i);
      const char = content[i];
      
      // æ—¢ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ã‚‹æ–‡å­—(\)ã¯ãã®ã¾ã¾ã«ã™ã‚‹ï¼ˆäºŒé‡ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å›é¿ï¼‰
      if (char === '\\') {
        obfuscatedContent += char + content[i+1];
        i++; // æ¬¡ã®æ–‡å­—ã‚‚ã‚¹ã‚­ãƒƒãƒ—
        continue;
      }

      // å®‰å…¨ãªæ–‡å­—ã ã‘é›£èª­åŒ–
      if (Math.random() > 0.5 && charCode < 127 && charCode > 31) {
        obfuscatedContent += '\\x' + charCode.toString(16).padStart(2, '0');
      } else {
        obfuscatedContent += char;
      }
    }

    return quote + obfuscatedContent + quote;
  });

  // ----------------------------------------------------------
  // Step 5: Evalåœ§ç¸® (JSON.stringifyã«ã‚ˆã‚‹å®‰å…¨ãªãƒ©ãƒƒãƒ”ãƒ³ã‚°)
  // ----------------------------------------------------------
  if (document.getElementById('wrapEval').checked) {
    // ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’JSONæ–‡å­—åˆ—åŒ–ã—ã¦ eval() ã«æ¸¡ã™
    // ã“ã‚Œã«ã‚ˆã‚Šæ”¹è¡Œã‚„ã‚¯ã‚©ãƒ¼ãƒˆãŒå®Œå…¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹
    code = `eval(${JSON.stringify(code)})`;
  }

  return code;
}

function processObfuscation() {
  const input = document.getElementById('input').value;
  if (!input.trim()) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const layers = parseInt(document.getElementById('layers').value);
  const status = document.getElementById('statusText');
  
  status.textContent = "å‡¦ç†ä¸­...";
  status.style.color = "#ff0";

  // UIæç”»ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†setTimeout
  setTimeout(() => {
    try {
      let currentCode = input;
      for(let i=0; i<layers; i++) {
        currentCode = obfuscateOnce(currentCode);
      }
      finalCode = currentCode;
      document.getElementById('output').textContent = finalCode;
      status.textContent = "âœ… é›£èª­åŒ–å®Œäº†";
      status.style.color = "#0f0";
    } catch(e) {
      status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
      status.style.color = "#f00";
      console.error(e);
    }
  }, 10);
}

function runTest() {
  if(!finalCode) return alert("å…ˆã«é›£èª­åŒ–ã—ã¦ãã ã•ã„");
  
  const status = document.getElementById('statusText');
  try {
    // console.logã‚’ãƒ•ãƒƒã‚¯ã—ã¦ç”»é¢ã«ã‚‚å‡ºã™
    const originalLog = console.log;
    let logOutput = "";
    console.log = (...args) => {
      logOutput += args.join(' ') + "\n";
      originalLog.apply(console, args);
    };

    // å®Ÿè¡Œ
    new Function(finalCode)();

    // æˆ»ã™
    console.log = originalLog;
    
    if(logOutput) {
      alert("å®Ÿè¡ŒæˆåŠŸï¼\n\n[console.logå‡ºåŠ›]\n" + logOutput);
    } else {
      alert("å®Ÿè¡ŒæˆåŠŸï¼ (ãƒ­ã‚°å‡ºåŠ›ãªã—)");
    }
    status.textContent = "âœ… å®Ÿè¡Œãƒ†ã‚¹ãƒˆæˆåŠŸ";
  } catch(e) {
    alert("å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼:\n" + e.message);
    status.textContent = "âŒ å®Ÿè¡Œå¤±æ•—";
    status.style.color = "#f00";
  }
}

function copyToClip() {
  if(!finalCode) return;
  navigator.clipboard.writeText(finalCode);
  document.getElementById('statusText').textContent = "ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
}

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é€£å‹•
document.getElementById('layers').addEventListener('input', e => {
  document.getElementById('layerVal').textContent = e.target.value;
});
</script>
</body>
</html>
