<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obfuscator Pro / Analytics Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-color: #0f1115;
            --card-bg: #161b22;
            --border-color: #30363d;
            --accent-primary: #3b82f6;
            --accent-hover: #60a5fa;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --code-bg: #0d1117;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Glass Card UI */
        .glass-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Controls */
        .form-switch .form-check-input {
            background-color: #334155;
            border-color: #475569;
            cursor: pointer;
        }
        .form-switch .form-check-input:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .form-range::-webkit-slider-runnable-track {
            background: #334155;
            border-radius: 4px;
        }
        .form-range::-webkit-slider-thumb {
            background: var(--accent-primary);
        }

        /* Editor */
        .code-editor {
            background-color: var(--code-bg);
            color: #e2e8f0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            resize: none;
            transition: border-color 0.2s;
        }
        .code-editor:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Buttons */
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            color: white;
        }

        .btn-outline-custom {
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            background: var(--card-bg);
        }
        .btn-outline-custom:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
            background: #1e293b;
        }

        /* Overlay */
        .spinner-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 17, 21, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(4px);
            border-radius: 8px;
        }

        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Stats Badge */
        .stats-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: #1e293b;
            padding: 4px 10px;
            border-radius: 4px;
            color: #94a3b8;
            border: 1px solid #334155;
            opacity: 0; /* hidden by default */
            transition: opacity 0.3s;
        }
        .stats-badge.visible {
            opacity: 1;
        }
        .stats-highlight {
            color: #60a5fa;
            font-weight: bold;
        }
        .stats-arrow {
            color: #64748b;
            margin: 0 6px;
        }
    </style>
</head>
<body class="py-4">

<div class="container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold m-0 text-white">⚡ Obfuscator <span style="color: var(--accent-primary)">Worker</span></h3>
            <small class="text-secondary">Multi-Threaded Protection with Analytics</small>
        </div>
        <a href="https://github.com/" target="_blank" class="btn btn-outline-custom btn-sm">
            <i class="bi bi-github"></i>
        </a>
    </div>

    <div class="row g-4">
        <!-- Advanced Settings Panel -->
        <div class="col-12">
            <div class="glass-card pb-2">
                <div class="row">
                    <!-- Protection -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-shield-check me-1"></i> Protection</div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="optAntiDebug" checked>
                            <label class="form-check-label" for="optAntiDebug">Anti-Debug (DevTools対策)</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="optSelfDefending" checked>
                            <label class="form-check-label" for="optSelfDefending">Self-Defending (改ざん検知)</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="optDomainLock">
                            <label class="form-check-label" for="optDomainLock">Domain Lock (ドメイン制限)</label>
                        </div>
                        <input type="text" id="domainName" class="form-control form-control-sm mt-2 bg-dark text-light border-secondary" placeholder="ex: mysite.com" style="display:none;">
                    </div>

                    <!-- Complexity -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-code-square me-1"></i> Complexity</div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="optDeadCode">
                            <label class="form-check-label" for="optDeadCode">Dead Code Injection (ダミー混入)</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="optSplitStrings" checked>
                            <label class="form-check-label" for="optSplitStrings">Split Strings (文字列分割)</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="optDisableConsole">
                            <label class="form-check-label" for="optDisableConsole">Remove Console (ログ削除)</label>
                        </div>
                    </div>

                    <!-- Potency Slider -->
                    <div class="col-md-4 mb-3">
                        <div class="section-title"><i class="bi bi-speedometer2 me-1"></i> Intensity</div>
                        <label for="optPotency" class="form-label d-flex justify-content-between small text-secondary">
                            <span>Performance</span>
                            <span>Security</span>
                        </label>
                        <input type="range" class="form-range" min="0" max="1" step="0.1" id="optPotency" value="0.5">
                        <div class="text-center small text-secondary mt-1">
                            Flattening: <span id="potencyVal">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="col-lg-6">
            <div class="d-flex justify-content-between mb-2 align-items-center">
                <label class="fw-bold small text-secondary">Input Source</label>
                <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary">JavaScript</span>
            </div>
            <textarea id="inputCode" class="form-control code-editor" rows="16" placeholder="// Paste your code here..."></textarea>
        </div>

        <!-- Output Area -->
        <div class="col-lg-6 position-relative">
            <!-- Loading Overlay -->
            <div id="processingOverlay" class="spinner-overlay" style="display: none;">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h5 class="text-white fw-bold">Processing...</h5>
                <p class="text-secondary small" id="statusText">Starting Worker...</p>
            </div>

            <div class="d-flex justify-content-between mb-2 align-items-center">
                <label class="fw-bold small text-secondary">Obfuscated Output</label>
                
                <!-- === ここに容量変化を表示するバッジを追加 === -->
                <div id="sizeStats" class="stats-badge">
                    <span id="sizeOriginal">0 B</span>
                    <i class="bi bi-arrow-right stats-arrow"></i>
                    <span id="sizeObfuscated" class="stats-highlight">0 B</span>
                    <span class="ms-2" id="sizeDiff">(+0%)</span>
                </div>
            </div>
            <textarea id="outputCode" class="form-control code-editor" rows="16" readonly onclick="this.select()"></textarea>
            
            <div class="mt-3 d-flex gap-2">
                <button id="copyBtn" class="btn btn-outline-custom flex-grow-1 btn-sm">
                    <i class="bi bi-clipboard me-1"></i> Copy Result
                </button>
                <button id="testBtn" class="btn btn-outline-custom flex-grow-1 btn-sm">
                    <i class="bi bi-play-fill me-1"></i> Test Run
                </button>
            </div>
        </div>
    </div>

    <!-- Main Execute -->
    <div class="text-center mt-5 mb-5">
        <button id="obfuscateBtn" class="btn btn-primary-custom btn-lg">
            <i class="bi bi-cpu-fill me-2"></i> Execute in Background
        </button>
    </div>
</div>

<!-- Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 99">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body small">
                <i class="bi bi-check-circle-fill me-2"></i> Copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Worker Script (Blob URL化して使用) -->
<script id="worker-script" type="javascript/worker">
    importScripts(
        'https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js',
        'https://cdn.jsdelivr.net/npm/javascript-obfuscator/dist/index.browser.js',
        'https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js'
    );

    const LZ_LIB_VAR_NAME = "_lz";
    const LZSTRING_LIB_SOURCE = `var ${LZ_LIB_VAR_NAME}=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var o=i._compress(r,6,function(r){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)});switch(o.length%4){case 0:return o;case 1:return o+"===";case 2:return o+"==";case 3:return o+"="}},decompressFromBase64:function(o){return null==o?"":""==o?null:i._decompress(o.length,32,function(n){return t("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o.charAt(n))})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,a,u,c,f,s,l,p=0,h=0,d="",v="",m=2,g=3;for(i=0;i<r.length;i+=1)if(d=r.charAt(i),Object.prototype.hasOwnProperty.call(e={},d)||(e[d]=g++,t={}),v=d,Object.prototype.hasOwnProperty.call(e,d)){if(256>d.charCodeAt(0)){for(e=0;m>e;e++)p<<=1,h==o-1?(h=0,d+=n(p),p=0):h++;for(f=d.charCodeAt(0),e=0;8>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}else{for(f=1,e=0;m>e;e++)p=p<<1|f,h==o-1?(h=0,d+=n(p),p=0):h++,f=0;for(f=d.charCodeAt(0),e=0;16>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}m--,0==m&&(m=Math.pow(2,a),a++),delete e[d]}else for(f=e[v],e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(m--,0==m&&(m=Math.pow(2,a),a++),f=2,e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(;;){if(p<<=1,h==o-1){d+=n(p);break}h++}return d},_decompress:function(o,n,e){var t,i,a,u,c,f,s,l,p=[],h=4,d=4,v=3,m="",g=[],C={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)p[i]=i;for(a=0,c=Math.pow(2,2),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 2:return""}for(p[3]=l,u=l,g.push(l);;){if(C.index>o)return"";for(a=0,c=Math.pow(2,v),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(l=a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 2:return g.join("")}if(0==h&&(h=Math.pow(2,v),v++),p[l])m=p[l];else{if(l!==d)return null;m=u+u.charAt(0)}g.push(m),p[d++]=u+m.charAt(0),h--,u=m,0==h&&(h=Math.pow(2,v),v++)}}};return i}();`;

    self.onmessage = async function(e) {
        const { code, config } = e.data;
        try {
            postMessage({ type: 'status', text: 'Minifying...' });

            // 0. Pre-process
            let codeToProcess = code;
            if (config.domainLock && config.domainName) {
                codeToProcess = `if(location.hostname!=="${config.domainName}"){throw "Unauthorized";}\n` + codeToProcess;
            }

            // 1. Minify
            const minifiedResult = await Terser.minify(codeToProcess, {
                mangle: true,
                compress: { passes: 1, drop_console: config.disableConsole }
            });
            if (minifiedResult.error) throw minifiedResult.error;
            
            postMessage({ type: 'status', text: 'Obfuscating Logic...' });

            // 2. Core Obfuscation
            const coreObfuscation = JavaScriptObfuscator.obfuscate(minifiedResult.code, {
                compact: true,
                controlFlowFlattening: true,
                controlFlowFlatteningThreshold: config.potency, 
                deadCodeInjection: config.deadCode,
                deadCodeInjectionThreshold: config.deadCode ? (config.potency * 0.5) : 0,
                numbersToExpressions: true,
                simplify: true,
                stringArray: true,
                stringArrayEncoding: ['rc4'],
                stringArrayThreshold: 0.75,
                splitStrings: config.splitStrings,
                debugProtection: config.antiDebug,
                debugProtectionInterval: config.antiDebug ? 4000 : 0,
                disableConsoleOutput: config.disableConsole,
                selfDefending: config.selfDefending
            }).getObfuscatedCode();

            postMessage({ type: 'status', text: 'Compressing & Wrapping...' });

            // 3. Compression
            const compressedPayload = LZString.compressToBase64(coreObfuscation);

            // 4. Wrapper
            const wrapperCode = `
/* javascript-obfuscator:disable */
${LZSTRING_LIB_SOURCE}
/* javascript-obfuscator:enable */
var payload = "${compressedPayload}";
var decompressed = ${LZ_LIB_VAR_NAME}.decompressFromBase64(payload);
(0, eval)(decompressed);
            `;

            // 5. Final Shell Obfuscation
            const finalResult = JavaScriptObfuscator.obfuscate(wrapperCode, {
                compact: true,
                identifierNamesGenerator: 'mangled',
                renameGlobals: false,
                unicodeEscapeSequence: true,
                stringArray: true,
                stringArrayEncoding: ['rc4'],
                stringArrayThreshold: 1,
                splitStrings: true,
                splitStringsChunkLength: 12
            }).getObfuscatedCode();

            postMessage({ type: 'success', result: finalResult });

        } catch (err) {
            postMessage({ type: 'error', message: err.message });
        }
    };
</script>

<script>
    // UI Logic
    document.getElementById('optDomainLock').addEventListener('change', function(e) {
        document.getElementById('domainName').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('optPotency').addEventListener('input', function(e) {
        document.getElementById('potencyVal').innerText = Math.round(e.target.value * 100) + "%";
    });

    // --- Helper: Byte Size Formatter ---
    function formatBytes(bytes, decimals = 1) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // --- Helper: Get Blob Size (More accurate than string length) ---
    function getByteSize(str) {
        return new Blob([str]).size;
    }

    let worker = null;

    function createWorker() {
        const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
        return new Worker(window.URL.createObjectURL(blob));
    }

    document.getElementById('obfuscateBtn').addEventListener('click', () => {
        const input = document.getElementById('inputCode').value;
        const outputArea = document.getElementById('outputCode');
        const overlay = document.getElementById('processingOverlay');
        const statusText = document.getElementById('statusText');
        const statsBadge = document.getElementById('sizeStats');

        const config = {
            antiDebug: document.getElementById('optAntiDebug').checked,
            selfDefending: document.getElementById('optSelfDefending').checked,
            domainLock: document.getElementById('optDomainLock').checked,
            domainName: document.getElementById('domainName').value.trim(),
            deadCode: document.getElementById('optDeadCode').checked,
            splitStrings: document.getElementById('optSplitStrings').checked,
            disableConsole: document.getElementById('optDisableConsole').checked,
            potency: parseFloat(document.getElementById('optPotency').value)
        };

        if (!input.trim()) {
            alert("Please enter JavaScript code.");
            return;
        }

        // UI Reset
        outputArea.value = "";
        overlay.style.display = 'flex';
        statusText.innerText = "Initializing...";
        statsBadge.classList.remove('visible'); // Hide stats during processing

        if (worker) worker.terminate();
        worker = createWorker();

        worker.postMessage({ code: input, config: config });

        worker.onmessage = function(e) {
            const data = e.data;

            if (data.type === 'status') {
                statusText.innerText = data.text;
            } else if (data.type === 'success') {
                outputArea.value = data.result;
                overlay.style.display = 'none';
                
                // --- 容量比較ロジック ---
                const originalSize = getByteSize(input);
                const resultSize = getByteSize(data.result);
                const diffPercent = ((resultSize - originalSize) / originalSize * 100).toFixed(0);
                
                // バッジの更新
                document.getElementById('sizeOriginal').innerText = formatBytes(originalSize);
                document.getElementById('sizeObfuscated').innerText = formatBytes(resultSize);
                
                const diffElem = document.getElementById('sizeDiff');
                if (resultSize > originalSize) {
                    diffElem.innerText = `(+${diffPercent}%)`;
                    diffElem.style.color = '#ef4444'; // Red for increase
                } else {
                    diffElem.innerText = `(${diffPercent}%)`;
                    diffElem.style.color = '#22c55e'; // Green for decrease
                }
                statsBadge.classList.add('visible');

                worker.terminate();
                worker = null;
            } else if (data.type === 'error') {
                console.error(data.message);
                outputArea.value = "Error: " + data.message;
                overlay.style.display = 'none';
                worker.terminate();
                worker = null;
            }
        };
    });

    // Helper Buttons
    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
    document.getElementById('copyBtn').addEventListener('click', () => {
        const val = document.getElementById('outputCode').value;
        if(val) navigator.clipboard.writeText(val).then(() => toast.show());
    });

    document.getElementById('testBtn').addEventListener('click', () => {
        const code = document.getElementById('outputCode').value;
        if(!code) return;
        if(confirm("Execute code in this browser tab?")) {
            try { (0, eval)(code); } catch(e) { alert("Error: " + e); }
        }
    });
</script>

</body>
</html>
