<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>三重難読化ツール（Terser＋Obfuscator＋Base91）</title>
<style>
  body { font-family: sans-serif; padding: 2rem; background: #f0f0f0; }
  textarea { width: 100%; height: 130px; }
  button { margin-top: 10px; padding: 10px; }
  .output-area { margin-top: 20px; }
 pre { white-space: pre-wrap; word-wrap: break-word; background: #fff; padding: 1rem; border: 1px solid #ccc; }
</style>
</head>
<body>

<h2>三重難読化ツール</h2>
<p>以下にJavaScriptコードを入力し、難読化してみてください（Terser→Obfuscator→Base91の順に処理されます）</p>

<textarea id="inputCode" placeholder="ここにJavaScriptコードを入力"></textarea>

<label>難読化レベル：</label>
<select id="obfLevel">
  <option value="low">弱</option>
  <option value="medium">中</option>
  <option value="high">強</option>
</select>

<button id="runBtn">難読化して実行コード生成</button>

<div class="output-area">
  <h3>難読化結果</h3>
  <pre id="output"></pre>
  <h3>容量増加</h3>
  <pre id="size"></pre>
</div>

<!-- 必須ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/javascript-obfuscator@4.1.0/dist/javascript-obfuscator.min.js"></script>

<script>
// ASCII Base91
function base91encode(data) {
  const table = '!#$%&()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"\'';
  const b = [];
  let ebq = 0, en = 0;

  for (let i = 0; i < data.length; i++) {
    ebq |= (data.charCodeAt(i) & 255) << en;
    en += 8;
    if (en > 13) {
      let v = ebq & 8191;

      if (v > 88) {
        ebq >>= 13;
        en -= 13;
      } else {
        v = ebq & 16383;
        ebq >>= 14;
        en -= 14;
      }

      b.push(table[v % table.length]);
      b.push(table[Math.floor(v / table.length)]);
    }
  }

  if (en > 0) {
    b.push(table[ebq % table.length]);
    if (en > 7 || ebq > 90) {
      b.push(table[Math.floor(ebq / table.length)]);
    }
  }

  return b.join('');
}

// 実行処理
document.getElementById('runBtn').onclick = async () => {
  const code = document.getElementById("inputCode").value;
  if (!code) return alert("何かコードを入力してください");

  // 1. Terser圧縮（最大）
  let compressed = await Terser.minify(code, { compress: true, mangle: true });
  let result = compressed.code || code;

  // 2. Obfuscate
  const level = document.getElementById("obfLevel").value;
  let options = {
    compact: true,
    controlFlowFlattening: level === 'high',
    deadCodeInjection: level === 'high',
    debugProtection: level === 'high',
    renameGlobals: level !== 'low'
  };
  result = JavaScriptObfuscator.obfuscate(result, options).getObfuscatedCode();

  // 3. Base91（ASCII版）
  const encoded = base91encode(result);
  const final = `eval(function(d){function f(b){const c='!#$%&()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_\`abcdefghijklmnopqrstuvwxyz{|}~"\'';let e=[],g=0,h=0;for(let i=0;i<b.length;i++){const k=c.indexOf(b[i]);if(k<0)continue;g+=k*(c.length**(h++));if(h>1){e.push(String.fromCharCode(g&255));g>>=8;h=0;}}return e.join('');}eval(f(d))})('${encoded}');`;

  // 結果表示
  document.getElementById("output").textContent = final;

  // 容量表示
  const originalSize = new Blob([code]).size;
  const finalSize = new Blob([final]).size;
  document.getElementById("size").textContent =
    `元のサイズ: ${originalSize} bytes\n難読化後: ${finalSize} bytes\n増加量: ${finalSize - originalSize} bytes`;
};
</script>

</body>
</html>
