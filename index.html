<script>
    // UI: Domain Lock
    document.getElementById('optDomainLock').addEventListener('change', function(e) {
        document.getElementById('domainName').style.display = e.target.checked ? 'block' : 'none';
    });

    // --- 修正ポイント 1 ---
    // LZ-Stringライブラリの変数名を 'LZString' から '_lz' に変更して定義
    // これにより、ツール本体がCDNから読み込んでいる 'window.LZString' との衝突（汚染）を防ぎます。
    // また、ReferenceErrorを防ぐため、このライブラリ部分には難読化除外タグを適用する設計にします。
    const LZ_LIB_VAR_NAME = "_lz"; 
    const LZSTRING_LIB_SOURCE = `var ${LZ_LIB_VAR_NAME}=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var o=i._compress(r,6,function(r){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)});switch(o.length%4){case 0:return o;case 1:return o+"===";case 2:return o+"==";case 3:return o+"="}},decompressFromBase64:function(o){return null==o?"":""==o?null:i._decompress(o.length,32,function(n){return t("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o.charAt(n))})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,a,u,c,f,s,l,p=0,h=0,d="",v="",m=2,g=3;for(i=0;i<r.length;i+=1)if(d=r.charAt(i),Object.prototype.hasOwnProperty.call(e={},d)||(e[d]=g++,t={}),v=d,Object.prototype.hasOwnProperty.call(e,d)){if(256>d.charCodeAt(0)){for(e=0;m>e;e++)p<<=1,h==o-1?(h=0,d+=n(p),p=0):h++;for(f=d.charCodeAt(0),e=0;8>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}else{for(f=1,e=0;m>e;e++)p=p<<1|f,h==o-1?(h=0,d+=n(p),p=0):h++,f=0;for(f=d.charCodeAt(0),e=0;16>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1}m--,0==m&&(m=Math.pow(2,a),a++),delete e[d]}else for(f=e[v],e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(m--,0==m&&(m=Math.pow(2,a),a++),f=2,e=0;a>e;e++)p=p<<1|1&f,h==o-1?(h=0,d+=n(p),p=0):h++,f>>=1;for(;;){if(p<<=1,h==o-1){d+=n(p);break}h++}return d},_decompress:function(o,n,e){var t,i,a,u,c,f,s,l,p=[],h=4,d=4,v=3,m="",g=[],C={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)p[i]=i;for(a=0,c=Math.pow(2,2),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;l=r(a);break;case 2:return""}for(p[3]=l,u=l,g.push(l);;){if(C.index>o)return"";for(a=0,c=Math.pow(2,v),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;switch(l=a){case 0:for(a=0,c=Math.pow(2,8),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 1:for(a=0,c=Math.pow(2,16),f=1;f!=c;)s=C.val&C.position,C.position>>=1,0==C.position&&(C.position=n,C.val=e(C.index++)),a|=(s>0?1:0)*f,f<<=1;p[d++]=r(a),l=d-1,h--;break;case 2:return g.join("")}if(0==h&&(h=Math.pow(2,v),v++),p[l])m=p[l];else{if(l!==d)return null;m=u+u.charAt(0)}g.push(m),p[d++]=u+m.charAt(0),h--,u=m,0==h&&(h=Math.pow(2,v),v++)}}};return i}();`;

    document.getElementById('obfuscateBtn').addEventListener('click', async () => {
        const input = document.getElementById('inputCode').value;
        const outputArea = document.getElementById('outputCode');
        const overlay = document.getElementById('processingOverlay');
        
        // Settings
        const s_antiDebug = document.getElementById('optAntiDebug').checked;
        const s_selfDefending = document.getElementById('optSelfDefending').checked;
        const s_disableConsole = document.getElementById('optDisableConsole').checked;
        const s_domainLock = document.getElementById('optDomainLock').checked;
        const val_domainName = document.getElementById('domainName').value.trim();

        if (!input.trim()) {
            alert("コードを入力してください");
            return;
        }

        overlay.style.display = 'flex';
        outputArea.value = "";
        // UI更新のためのウェイト
        await new Promise(r => setTimeout(r, 100));

        try {
            // --- Step 0: Pre-process ---
            let codeToProcess = input;
            if (s_domainLock && val_domainName) {
                codeToProcess = `if(location.hostname!=="${val_domainName}"){throw "Unauthorized";}\n` + codeToProcess;
            }

            // --- Step 1: Minify (Terser) ---
            const minifiedResult = await Terser.minify(codeToProcess, {
                mangle: true,
                compress: {
                    passes: 1, 
                    drop_console: s_disableConsole
                }
            });
            if (minifiedResult.error) throw minifiedResult.error;
            const minifiedCode = minifiedResult.code;

            // --- Step 2: Core Obfuscation (Inner Layer) ---
            const coreObfuscation = JavaScriptObfuscator.obfuscate(minifiedCode, {
                compact: true,
                controlFlowFlattening: true,
                controlFlowFlatteningThreshold: 0.8,
                numbersToExpressions: true,
                simplify: true,
                stringArray: true,
                stringArrayEncoding: ['rc4'],
                stringArrayThreshold: 0.8,
                
                debugProtection: s_antiDebug,
                debugProtectionInterval: s_antiDebug ? 4000 : 0,
                disableConsoleOutput: s_disableConsole,
                selfDefending: s_selfDefending
            }).getObfuscatedCode();

            // --- Step 3: Compression (Using Tool's Safe LZString) ---
            // ツールが持っている window.LZString を使って圧縮
            const compressedPayload = LZString.compressToBase64(coreObfuscation);

            // --- Step 4: Wrapper Construction ---
            // 変数名を _lz に変えたライブラリソースを埋め込む
            const wrapperCode = `
                /* javascript-obfuscator:disable */
                ${LZSTRING_LIB_SOURCE}
                /* javascript-obfuscator:enable */

                var payload = "${compressedPayload}";
                
                // 変数名を変更した _lz を使用して展開
                var decompressed = ${LZ_LIB_VAR_NAME}.decompressFromBase64(payload);
                
                (0, eval)(decompressed);
            `;

            // --- Step 5: Wrapper Obfuscation (Outer Shell) ---
            const finalResult = JavaScriptObfuscator.obfuscate(wrapperCode, {
                compact: true,
                identifierNamesGenerator: 'mangled',
                renameGlobals: false, 
                unicodeEscapeSequence: true,
                stringArray: true,
                stringArrayThreshold: 1,
                splitStrings: true
            }).getObfuscatedCode();

            outputArea.value = finalResult;

        } catch (error) {
            console.error(error);
            outputArea.value = "Error: " + error.message;
        } finally {
            overlay.style.display = 'none';
        }
    });

    // Clipboard
    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
    document.getElementById('copyBtn').addEventListener('click', () => {
        const val = document.getElementById('outputCode').value;
        if(val) navigator.clipboard.writeText(val).then(() => toast.show());
    });

    // Test Run
    document.getElementById('testBtn').addEventListener('click', () => {
        const code = document.getElementById('outputCode').value;
        if(!code) return;
        
        if(confirm("実行しますか？\n(無限ループ等に注意してください)")) {
            try { 
                // 実行はグローバルスコープで行うが、
                // 埋め込まれた _lz 変数が window.LZString を上書きしないため安全
                (0, eval)(code); 
            } catch(e) { 
                alert("Runtime Error: " + e); 
            }
        }
    });
</script>
