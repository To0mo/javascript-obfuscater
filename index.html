<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能 JavaScript 難読化・圧縮ツール</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; background-color: #f6f8fa; }
        .header { background-color: #24292e; color: white; padding: 16px; text-align: center; }
        .main-container { display: flex; flex-direction: column; padding: 16px; gap: 16px; }
        .io-container { display: flex; gap: 16px; height: 55vh; }
        textarea { width: 100%; height: 100%; font-family: monospace; font-size: 14px; border: 1px solid #d1d5da; border-radius: 6px; padding: 8px; resize: vertical; }
        .options-container { background-color: white; border: 1px solid #d1d5da; border-radius: 6px; padding: 16px; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: center;}
        .option-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 600; }
        select, button { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #d1d5da; font-size: 14px; }
        .process-button { background-color: #2ea44f; color: white; font-weight: 600; cursor: pointer; border-color: #2ea44f; }
        .process-button:hover:not(:disabled) { background-color: #2c974b; }
        .process-button:disabled { background-color: #94d3a2; cursor: not-allowed; }
        .result-info { margin-top: 16px; background-color: #eef5ff; padding: 16px; border-radius: 6px; border: 1px solid #c8d9f5; }
        .result-info strong { font-size: 1.2em; }
        .warning { color: #d73a49; font-weight: bold; }
        .success { color: #2ea44f; font-weight: bold; }
    </style>
    <!-- 必要なライブラリをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/javascript-obfuscator@4.1.0/dist/index.browser.js"></script>
    <!-- LZ-String ライブラリを追加 -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
</head>
<body>
    <header class="header"><h1>高機能 JavaScript 難読化・圧縮ツール</h1></header>

    <main class="main-container">
        <div class="io-container">
            <textarea id="input-code" placeholder="ここにJavaScriptコードを入力..."></textarea>
            <textarea id="output-code" readonly placeholder="処理結果がここに出力されます..."></textarea>
        </div>

        <div class="options-container">
            <div class="options-grid">
                <div class="option-group">
                    <label for="use-terser">1. Terser 圧縮</label>
                    <select id="use-terser"><option value="yes" selected>有効</option><option value="no">無効</option></select>
                </div>
                <div class="option-group">
                    <label for="obfuscator-preset">2. 難読化レベル</label>
                    <select id="obfuscator-preset"><option value="low">低 (サイズ重視)</option><option value="medium" selected>中 (バランス)</option><option value="high">高 (難読化重視)</option></select>
                </div>
                <div class="option-group">
                    <label for="encoding-type">3. 最終エンコード</label>
                    <select id="encoding-type">
                        <option value="none" selected>なし</option>
                        <option value="lz-string">LZ-String + Base64 (最高圧縮)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>&nbsp;</label>
                    <button id="process-btn" class="process-button">処理を実行</button>
                </div>
            </div>
        </div>

        <div id="result-info" class="result-info">結果はここに表示されます。</div>
    </main>

    <script>
        document.getElementById('process-btn').addEventListener('click', async () => {
            const inputCode = document.getElementById('input-code').value;
            const outputArea = document.getElementById('output-code');
            const resultInfo = document.getElementById('result-info');

            if (!inputCode.trim()) {
                outputArea.value = "エラー: コードが入力されていません。";
                resultInfo.innerHTML = "コードを入力してから実行してください。";
                return;
            }

            const processBtn = document.getElementById('process-btn');
            processBtn.disabled = true;
            processBtn.textContent = '処理中...';
            outputArea.value = '';
            resultInfo.innerHTML = '処理を開始します...';
            
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                let processedCode = inputCode;
                const originalSize = new Blob([inputCode]).size;

                // Step 1: Terser
                if (document.getElementById('use-terser').value === 'yes') {
                    const terserResult = await Terser.minify(processedCode, { mangle: { toplevel: true } });
                    if (terserResult.error) throw terserResult.error;
                    processedCode = terserResult.code;
                }

                // Step 2: Obfuscator
                const preset = document.getElementById('obfuscator-preset').value;
                if (preset !== 'none') {
                    const options = getObfuscatorOptions(preset);
                    processedCode = JavaScriptObfuscator.obfuscate(processedCode, options).getObfuscatedCode();
                }

                // Step 3: Final Encoding
                const encodingType = document.getElementById('encoding-type').value;
                if (encodingType === 'lz-string') {
                    // LZ-Stringで圧縮し、安全なBase64形式でエンコード
                    const compressed = LZString.compressToBase64(processedCode);
                    // 復元用のデコーダーと実行コードを生成
                    processedCode = `(d=>{new Function(LZString.decompressFromBase64(d))()})('${compressed}')`;
                }
                
                // Finalize and Display
                const finalSize = new Blob([processedCode]).size;
                const ratio = finalSize > 0 ? (finalSize / originalSize) : 0;
                outputArea.value = processedCode;
                
                let resultHTML = `
                    元のサイズ: ${originalSize.toLocaleString()} バイト<br>
                    出力サイズ: ${finalSize.toLocaleString()} バイト<br>
                    サイズ比: <strong>${ratio.toFixed(2)} 倍</strong>
                `;
                
                if (ratio > 1.6) {
                    resultHTML += `<br><span class="warning">警告: 目標の1.6倍を超えました。難読化レベルを下げてみてください。</span>`;
                } else if (finalSize > 0) {
                     resultHTML += `<br><span class="success">目標の1.6倍以内に収まっています！</span>`;
                }
                resultInfo.innerHTML = resultHTML;

            } catch (e) {
                const errorMessage = `エラー: ${e.message}\n\nLine: ${e.line}, Col: ${e.col}, Pos: ${e.pos}`;
                outputArea.value = errorMessage;
                resultInfo.innerHTML = `<span class="warning">処理中にエラーが発生しました。</span>`;
                console.error(e);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = '処理を実行';
            }
        });

        function getObfuscatorOptions(preset) {
            // ... (この関数は変更ありません)
            switch(preset) {
                case 'high': return { compact: true, controlFlowFlattening: true, controlFlowFlatteningThreshold: 1, deadCodeInjection: true, deadCodeInjectionThreshold: 1, debugProtection: true, disableConsoleOutput: true, selfDefending: true, stringArray: true, stringArrayEncoding: ['base64'], rotateStringArray: true, transformObjectKeys: true, unicodeEscapeSequence: true };
                case 'medium': return { compact: true, controlFlowFlattening: true, controlFlowFlatteningThreshold: 0.75, deadCodeInjection: true, deadCodeInjectionThreshold: 0.4, debugProtection: false, disableConsoleOutput: true, selfDefending: true, stringArray: true, stringArrayThreshold: 0.75, rotateStringArray: true, };
                default: return { compact: true, simplify: true, stringArray: true, stringArrayThreshold: 0.75, splitStrings: true, splitStringsChunkLength: 10, };
            }
        }
    </script>
</body>
</html>
