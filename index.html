<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>三重難読化ツール (ASCII Base91版)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; text-align: center; }
    textarea { width: 95%; height: 180px; margin: 10px 0; font-size: 14px; }
    select, button { padding: 8px 16px; font-size: 14px; margin: 5px; }
    #sizeInfo { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>三重難読化ツール (ASCII Base91版)</h1>
  <textarea id="inputCode" placeholder="ここに JavaScript コードを入力"></textarea><br>

  難読化レベル：
  <select id="obfuscationLevel">
    <option value="low">弱</option>
    <option value="medium" selected>中</option>
    <option value="high">強</option>
  </select>
  <button id="obfuscateBtn">難読化する</button>
  <button id="copyBtn">コピー</button>
  <textarea id="outputCode" placeholder="難読化されたコードが表示されます"></textarea>
  <div id="sizeInfo"></div>

  <!-- ライブラリ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/javascript-obfuscator/dist/javascript-obfuscator.min.js"></script>

  <script>
    // ASCII限定 Base91
    const Base91 = (function(){
      const table = [...'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"#$%&\'()*+,-./:;<=>?@[]^_`{|}~'];
      const dectable = {};
      table.forEach((c,i)=>dectable[c]=i);

      function encode(str){
        let b=0,n=0,out='';
        for(let i=0;i<str.length;i++){
          b|=str.charCodeAt(i)<<n;
          n+=8;
          while(n>13){
            let v=b&8191;
            if(v>88){b>>=13;n-=13}else{v=b&16383;b>>=14;n-=14;}
            out+=table[v%91]+table[Math.floor(v/91)];
          }
        }
        if(n) out+=table[b%91]+table[Math.floor(b/91)];
        return out;
      }

      function decode(str){
        let b=0,n=0,out='',v=-1;
        for(let i=0;i<str.length;i++){
          let c=dectable[str[i]];
          if(v<0){v=c}else{v+=c*91;b|=v<<n;n=(v&8191)>88?n+13:n+14;while(n>=8){out+=String.fromCharCode(b&255);b>>=8;n-=8;}v=-1;}
        }
        return out;
      }

      return {encode, decode};
    })();
  </script>

  <script>
    document.getElementById("obfuscateBtn").addEventListener("click", async () => {
      let code = document.getElementById("inputCode").value.trim();
      if(!code) return alert("コードを入力してください");

      const level = document.getElementById("obfuscationLevel").value;
      let obfuscatorOptions = {compact:true, stringArray:true, stringArrayEncoding:['base64']};

      // 難読化レベル設定
      switch(level){
        case 'low':
          obfuscatorOptions.controlFlowFlattening=false;
          obfuscatorOptions.identifierNamesGenerator='hexadecimal';
          break;
        case 'medium':
          obfuscatorOptions.controlFlowFlattening=true;
          obfuscatorOptions.controlFlowFlatteningThreshold=0.3;
          obfuscatorOptions.identifierNamesGenerator='hexadecimal';
          break;
        case 'high':
          obfuscatorOptions.controlFlowFlattening=true;
          obfuscatorOptions.controlFlowFlatteningThreshold=1;
          obfuscatorOptions.identifierNamesGenerator='mangled';
          break;
      }

      try {
        // 1. Terser 圧縮（最大）
        const terserResult = await Terser.minify(code, { compress:true, mangle:true });
        if(terserResult.error) throw terserResult.error;

        // 2. Obfuscator
        const obfuscated = JavaScriptObfuscator.obfuscate(terserResult.code, obfuscatorOptions).getObfuscatedCode();

        // 3. ASCII Base91
        const encoded = Base91.encode(obfuscated);

        // 実行形式
        const finalCode = `eval(Base91.decode('${encoded}'));`;
        document.getElementById("outputCode").value = finalCode;

        // サイズ表示
        const originalSize = new TextEncoder().encode(code).length;
        const finalSize = new TextEncoder().encode(finalCode).length;
        document.getElementById("sizeInfo").innerText =
          `元サイズ: ${originalSize} バイト → 難読化後: ${finalSize} バイト (増減: ${finalSize-originalSize} バイト)`;

      } catch(e){
        alert("エラー: " + e.message);
      }
    });

    document.getElementById("copyBtn").addEventListener("click", () => {
      const out = document.getElementById("outputCode");
      if(!out.value) return alert("出力がありません");
      out.select();
      document.execCommand("copy");
      alert("コピーしました！");
    });
  </script>
</body>
</html>
